<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ขายที่ดิน – Google Login</title>

<style>
body{margin:0;font-family:system-ui;background:#f7f8fb}
header{background:#fff;border-bottom:1px solid #e5e7eb;padding:12px 16px;display:flex;align-items:center;gap:10px}
.btn{padding:8px 12px;border-radius:8px;border:0;background:#2563eb;color:#fff;cursor:pointer}
.btn.ghost{background:#eef2ff;color:#1e40af}
.hidden{display:none}
.wrap{max-width:1000px;margin:20px auto;padding:0 16px}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px}
.card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;overflow:hidden}
.thumb{width:100%;aspect-ratio:16/10;object-fit:cover;background:#eee}
.meta{padding:10px}
.muted{color:#6b7280;font-size:13px}
dialog{border:0;border-radius:14px;padding:16px}
</style>
</head>

<body>

<header>
  <img id="avatar" class="hidden" style="width:32px;height:32px;border-radius:50%">
  <span id="userName" class="muted"></span>
  <div style="flex:1"></div>
  <button id="btnLogin" class="btn ghost">Login Google</button>
  <button id="btnNew" class="btn hidden">+ ลงประกาศ</button>
</header>

<main class="wrap">
  <input id="q" placeholder="ค้นหา..." style="width:100%;padding:10px;margin-bottom:12px">
  <section id="board" class="grid"></section>
</main>

<dialog id="dlg">
  <h3>ลงประกาศขายที่ดิน</h3>
  <input id="title" placeholder="หัวเรื่อง" style="width:100%;padding:8px"><br><br>
  <input id="price" type="number" placeholder="ราคา"><br><br>
  <textarea id="body" placeholder="รายละเอียด" style="width:100%;height:80px"></textarea><br><br>
  <input type="file" id="img"><br><br>
  <button class="btn" onclick="savePost()">บันทึก</button>
  <button class="btn ghost" onclick="dlg.close()">ยกเลิก</button>
</dialog>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxn9WF_XSX2qc2rhtzXCDJaWNkjKuliuRzfRWPOoqMAzNnSP80Yk6DsOOSC8TXVw2QDgw/exec";

let posts = [];
let currentUser = null;

async function whoami(force=false){
  const r = await fetch(API_URL + "?action=whoami");
  const d = await r.json();

  currentUser = d.email || null;

  if (currentUser){
    userName.textContent = d.name || d.email;
    avatar.src = d.photo || "https://www.gstatic.com/images/branding/product/1x/avatar_circle_blue_512dp.png";
    avatar.classList.remove("hidden");
    btnNew.classList.remove("hidden");
    btnLogin.classList.add("hidden");
  } else {
    userName.textContent = "ยังไม่ได้เข้าสู่ระบบ";
    avatar.classList.add("hidden");
    btnNew.classList.add("hidden");
    btnLogin.classList.remove("hidden");
  }
}

btnLogin.onclick = () => whoami(true);

async function loadPosts(){
  const r = await fetch(API_URL + "?action=list");
  const d = await r.json();
  posts = d.posts || [];
  render();
}

function render(){
  const kw = q.value.toLowerCase();
  board.innerHTML = posts.filter(p =>
    !kw || (p.title||"").toLowerCase().includes(kw)
  ).map(p => {
    const owner = currentUser && p.author === currentUser;
    return `
      <article class="card">
        <img class="thumb" src="${p.images?.[0]?.url||''}">
        <div class="meta">
          <b>${p.title||'-'}</b>
          <div class="muted">ราคา: ${p.price||'-'}</div>
          ${owner ? `
            <button class="btn ghost" onclick="edit('${p.id}')">แก้ไข</button>
            <button class="btn ghost" onclick="delPost('${p.id}')">ลบ</button>
          ` : ``}
        </div>
      </article>
    `;
  }).join("") || "<div class='muted'>ยังไม่มีประกาศ</div>";
}
q.oninput = render;

const dlg = document.getElementById("dlg");
btnNew.onclick = () => dlg.showModal();

async function savePost(){
  let images = [];
  if (img.files[0]){
    images.push({ url: await uploadImage(img.files[0]) });
  }

  await fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({
      action:"save",
      post:{
        title:title.value,
        price:price.value,
        body:body.value,
        images
      }
    })
  });

  dlg.close();
  loadPosts();
}

async function delPost(id){
  if (!confirm("ลบประกาศนี้?")) return;
  await fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({
      action:"delete",
      id
    })
  });
  loadPosts();
}

function fileToBase64(file){
  return new Promise(res=>{
    const r=new FileReader();
    r.onload=()=>res(r.result);
    r.readAsDataURL(file);
  });
}

async function uploadImage(file){
  const b64 = await fileToBase64(file);
  const r = await fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({
      action:"upload",
      base64:b64.split(",")[1],
      name:file.name
    })
  });
  return (await r.json()).url;
}

whoami();
loadPosts();
</script>

</body>
</html>
