<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Land Market Pro | ศูนย์กลางซื้อขายที่ดินระดับพรีเมียม</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<!-- Leaflet Map CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<!-- Leaflet Map JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Sarabun', 'sans-serif'],
            display: ['Prompt', 'sans-serif'],
          },
          colors: {
            primary: {
              50: '#f0f9ff',
              100: '#e0f2fe',
              500: '#0ea5e9',
              600: '#0284c7',
              700: '#0369a1',
              800: '#075985', // Corporate Blue
              900: '#0c4a6e', // Deep Navy
            },
            secondary: {
              800: '#1e293b', // Slate 800
              900: '#0f172a', // Slate 900
            }
          }
        }
      }
    }
</script>

<style>
    body { font-family: 'Sarabun', sans-serif; background-color: #f8fafc; color: #334155; }
    h1, h2, h3, h4, h5, h6, .font-display { font-family: 'Prompt', sans-serif; }
    
    /* Professional Scrollbar */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #f1f5f9; }
    ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #64748b; }
    
    /* Dialog Animation - Crisp */
    dialog {
        transition: opacity 0.2s ease-out, transform 0.2s ease-out;
        opacity: 0;
        transform: scale(0.98);
    }
    dialog[open] {
        opacity: 1;
        transform: scale(1);
    }
    dialog::backdrop { background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(2px); }
    
    /* Map Height */
    #map { height: 300px; width: 100%; z-index: 1; border-radius: 0.5rem; }
    #viewMap { height: 350px; width: 100%; z-index: 1; border-radius: 0.5rem; }
    
    /* Utilities */
    .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    
    /* Image Slider */
    #imageSlider { transition: opacity 0.3s ease; }
    .slider-hidden { opacity: 0; pointer-events: none; }
    .slider-visible { opacity: 1; pointer-events: auto; }

    /* Inputs */
    .input-error { border-color: #ef4444 !important; background-color: #fef2f2; }
</style>
</head>
<body class="min-h-screen flex flex-col pb-safe bg-slate-50">

<!-- Professional Navbar -->
<nav class="bg-secondary-900 text-white shadow-md sticky top-0 z-50">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex justify-between items-center">
      <div class="flex items-center gap-3 cursor-pointer" onclick="refreshApp()">
        <div class="w-10 h-10 bg-primary-700 flex items-center justify-center rounded text-white shadow-lg">
            <i class="fa-solid fa-building-columns text-xl"></i>
        </div>
        <div class="flex flex-col">
            <span class="font-display font-bold text-xl leading-none tracking-wide">LAND<span class="text-primary-500">MARKET</span></span>
            <span class="text-[10px] text-slate-400 uppercase tracking-widest mt-0.5">Professional Real Estate</span>
        </div>
      </div>
      
      <div class="flex items-center gap-4">
         <button onclick="openNewPostModal()" class="hidden md:flex bg-primary-700 hover:bg-primary-600 text-white px-5 py-2 rounded-lg text-sm font-medium transition-colors shadow-sm items-center gap-2 border border-primary-600">
            <i class="fa-solid fa-plus"></i> ลงประกาศขาย
         </button>
         <!-- Mobile Add Button -->
         <button onclick="openNewPostModal()" class="md:hidden text-white bg-primary-700 p-2 rounded-lg">
            <i class="fa-solid fa-plus"></i>
         </button>
      </div>
  </div>
</nav>

<!-- Hero Section: Serious & Clean -->
<div class="bg-white border-b border-slate-200 shadow-sm relative z-40">
    <div class="max-w-7xl mx-auto px-4 py-10 md:py-16 flex flex-col items-center text-center">
        <h1 class="text-2xl md:text-3xl font-bold text-slate-800 mb-2">ค้นหาที่ดินเพื่อการลงทุนและอยู่อาศัย</h1>
        <p class="text-slate-500 mb-8 max-w-2xl font-light">รวบรวมที่ดินศักยภาพสูงทั่วประเทศ ข้อมูลครบถ้วน เชื่อถือได้</p>
        
        <!-- Single Search Bar -->
        <div class="w-full max-w-2xl relative shadow-lg rounded-lg group focus-within:ring-4 focus-within:ring-primary-100 transition-all">
            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                <i class="fa-solid fa-magnifying-glass text-slate-400 text-lg"></i>
            </div>
            <input id="q_main" type="text" 
                class="block w-full pl-12 pr-32 py-4 bg-white border border-slate-300 rounded-lg leading-5 placeholder-slate-400 focus:outline-none focus:border-primary-500 focus:ring-0 sm:text-lg text-slate-900 transition-colors" 
                placeholder="ค้นหาทำเล, จังหวัด, หรือช่วงราคา..."
                oninput="debounce(applyFilters, 300)()"
            >
            <div class="absolute inset-y-0 right-1 flex py-1.5">
                <button onclick="applyFilters()" class="bg-secondary-900 hover:bg-secondary-800 text-white px-6 rounded-md text-sm font-medium transition-colors">
                    ค้นหา
                </button>
            </div>
        </div>
    </div>
</div>

<main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10 w-full">
    
    <div class="flex justify-between items-end mb-6 border-b border-slate-200 pb-4">
        <div>
            <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                <i class="fa-solid fa-list-ul text-primary-700"></i> 
                รายการประกาศขาย
            </h2>
        </div>
        <span id="resultCount" class="text-sm font-medium text-slate-500">
            ทั้งหมด 0 รายการ
        </span>
    </div>
    
    <!-- Loading State -->
    <div id="loading" class="flex flex-col items-center justify-center py-20 text-slate-400">
        <i class="fa-solid fa-circle-notch fa-spin text-3xl text-primary-700 mb-4"></i>
        <p class="font-light">กำลังประมวลผลข้อมูล...</p>
    </div>
    
    <!-- GRID LAYOUT: 3 COLUMNS Mobile & Desktop -->
    <section id="board" class="grid grid-cols-3 gap-3 md:gap-8 pb-10 hidden"></section>

    <!-- Pagination -->
    <div id="pagination" class="flex justify-center items-center gap-2 pb-12 hidden">
        <button onclick="changePage(-1)" id="btnPrev" class="px-4 py-2 bg-white border border-slate-300 rounded hover:bg-slate-50 disabled:opacity-50 text-slate-700 text-sm font-medium transition-colors">
            ย้อนกลับ
        </button>
        <span id="pageIndicator" class="px-4 py-2 text-sm text-slate-600 font-medium">1 / 1</span>
        <button onclick="changePage(1)" id="btnNext" class="px-4 py-2 bg-white border border-slate-300 rounded hover:bg-slate-50 disabled:opacity-50 text-slate-700 text-sm font-medium transition-colors">
            ถัดไป
        </button>
    </div>
</main>

<footer class="bg-secondary-900 text-slate-400 mt-auto py-10 border-t border-secondary-800">
    <div class="max-w-7xl mx-auto px-4 text-center">
        <div class="flex justify-center items-center gap-2 mb-4 text-white">
            <i class="fa-solid fa-building-columns text-2xl"></i>
            <span class="font-display font-bold text-2xl">LANDMARKET</span>
        </div>
        <p class="text-sm mb-6 max-w-md mx-auto">แพลตฟอร์มสื่อกลางสำหรับการซื้อขายที่ดิน อสังหาริมทรัพย์ และการลงทุนที่น่าเชื่อถือ</p>
        <div class="text-xs text-slate-500">
            &copy; 2024 LandMarket Professional. All rights reserved.
        </div>
    </div>
</footer>

<!-- View Details Dialog -->
<dialog id="viewDlg" class="bg-white rounded-lg shadow-2xl p-0 w-[95%] max-w-4xl m-auto backdrop:bg-slate-900/60 max-h-[90vh] overflow-hidden">
    <div class="flex flex-col h-full max-h-[90vh]">
        <!-- Header -->
        <div class="bg-slate-50 px-6 py-4 border-b border-slate-200 flex justify-between items-center sticky top-0 z-10">
            <h3 class="font-display font-bold text-lg text-slate-800">รายละเอียดทรัพย์สิน</h3>
            <button onclick="closeViewModal()" class="text-slate-400 hover:text-red-600 transition-colors">
                <i class="fa-solid fa-times text-xl"></i>
            </button>
        </div>

        <div class="overflow-y-auto p-0 flex-grow flex flex-col md:flex-row">
            <!-- Left: Gallery -->
            <div class="w-full md:w-1/2 bg-slate-100 p-4 md:border-r border-slate-200 flex flex-col">
                <div class="aspect-video w-full bg-slate-200 rounded-lg overflow-hidden mb-3 relative group cursor-pointer" onclick="if(sliderImages.length>0) openImageSlider(0)">
                    <img id="viewMainImage" src="" class="w-full h-full object-cover">
                    <div class="absolute inset-0 bg-black/0 group-hover:bg-black/20 transition-colors flex items-center justify-center">
                        <i class="fa-solid fa-expand text-white opacity-0 group-hover:opacity-100 transition-opacity drop-shadow-md text-3xl"></i>
                    </div>
                </div>
                <div id="viewImages" class="flex gap-2 overflow-x-auto pb-2 h-20 flex-shrink-0"></div>
            </div>

            <!-- Right: Content -->
            <div class="w-full md:w-1/2 p-6 md:p-8">
                <div class="mb-6">
                    <div class="flex justify-between items-start gap-4 mb-2">
                        <h2 id="viewTitle" class="text-2xl font-bold text-slate-800 leading-tight"></h2>
                    </div>
                    <p id="viewPriceHeader" class="text-3xl font-display font-bold text-primary-700"></p>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-6 text-sm">
                    <div class="border border-slate-200 p-3 rounded">
                        <span class="block text-xs text-slate-500 uppercase tracking-wider mb-1">ทำเลที่ตั้ง</span>
                        <div class="font-medium text-slate-800 flex items-center gap-2">
                            <i class="fa-solid fa-map-marker-alt text-primary-600"></i> <span id="viewLocation" class="truncate"></span>
                        </div>
                    </div>
                    <div class="border border-slate-200 p-3 rounded">
                        <span class="block text-xs text-slate-500 uppercase tracking-wider mb-1">ผู้ติดต่อ</span>
                        <div class="font-medium text-slate-800 flex items-center gap-2">
                            <i class="fa-solid fa-user-tie text-primary-600"></i> <span id="viewContact" class="truncate"></span>
                        </div>
                    </div>
                </div>

                <div class="prose prose-sm text-slate-600 mb-8 max-w-none">
                    <h4 class="font-bold text-slate-800 mb-2 border-b border-slate-100 pb-1">รายละเอียดเพิ่มเติม</h4>
                    <div id="viewBody" class="whitespace-pre-line leading-relaxed"></div>
                </div>

                <div id="viewMapContainer" class="hidden mb-6">
                    <h4 class="font-bold text-slate-800 mb-2 text-sm">แผนที่</h4>
                    <div id="viewMap" class="rounded border border-slate-200 h-48"></div>
                    <a id="viewMapLink" href="#" target="_blank" class="text-xs text-primary-600 hover:underline mt-1 inline-block">เปิดใน Google Maps</a>
                </div>

                <div class="mt-auto pt-6 border-t border-slate-100 flex justify-end">
                    <button id="btnDeletePost" class="text-red-500 hover:text-red-700 text-sm font-medium px-4 py-2 border border-transparent hover:bg-red-50 rounded transition-colors">
                        <i class="fa-solid fa-trash-alt mr-1"></i> ลบประกาศ
                    </button>
                </div>
            </div>
        </div>
    </div>
</dialog>

<!-- Image Slider -->
<div id="imageSlider" class="fixed inset-0 z-[70] bg-black/95 flex items-center justify-center slider-hidden hidden">
    <button onclick="closeImageSlider()" class="absolute top-6 right-6 text-white hover:text-slate-300 transition-colors">
        <i class="fa-solid fa-times text-3xl"></i>
    </button>
    <button onclick="changeSlide(-1)" class="absolute left-6 text-white hover:text-slate-300 p-4 hidden md:block"><i class="fa-solid fa-chevron-left text-3xl"></i></button>
    <img id="sliderMainImage" src="" class="max-w-[90vw] max-h-[90vh] object-contain shadow-2xl">
    <button onclick="changeSlide(1)" class="absolute right-6 text-white hover:text-slate-300 p-4 hidden md:block"><i class="fa-solid fa-chevron-right text-3xl"></i></button>
    <div class="absolute bottom-6 text-white font-mono text-sm bg-black/50 px-4 py-1 rounded-full border border-white/20">
        <span id="sliderCounter">1 / 1</span>
    </div>
</div>

<!-- Form Modal -->
<dialog id="dlg" class="bg-white rounded-lg shadow-2xl p-0 w-[95%] max-w-xl m-auto backdrop:bg-slate-900/60">
    <div class="bg-slate-50 px-6 py-4 border-b border-slate-200 flex justify-between items-center">
        <h3 class="font-display font-bold text-lg text-slate-800">ลงประกาศใหม่</h3>
        <div class="flex gap-2">
            <button onclick="fillDemoData()" class="text-xs bg-slate-200 hover:bg-slate-300 text-slate-700 px-3 py-1 rounded font-medium transition-colors">Demo Data</button>
            <button onclick="closeModal()" class="text-slate-400 hover:text-red-600"><i class="fa-solid fa-times text-lg"></i></button>
        </div>
    </div>
    
    <div class="p-6 overflow-y-auto max-h-[75vh] space-y-5 custom-scrollbar">
        <input type="hidden" id="postId">
        <input type="hidden" id="lat">
        <input type="hidden" id="lng">
        
        <div>
            <label class="block text-sm font-semibold text-slate-700 mb-1">หัวข้อประกาศ <span class="text-red-500">*</span></label>
            <input id="title" type="text" class="w-full px-3 py-2 bg-white border border-slate-300 rounded focus:border-primary-500 focus:ring-1 focus:ring-primary-500 outline-none transition-all text-sm text-slate-800" placeholder="เช่น ขายที่ดิน 5 ไร่ ติดถนนใหญ่">
        </div>
        
        <div class="grid grid-cols-2 gap-4">
             <div>
                <label class="block text-sm font-semibold text-slate-700 mb-1">จังหวัด <span class="text-red-500">*</span></label>
                <select id="input_province" class="w-full px-3 py-2 bg-white border border-slate-300 rounded focus:border-primary-500 outline-none text-sm text-slate-800">
                    <option value="">เลือกจังหวัด</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-semibold text-slate-700 mb-1">ราคา (บาท) <span class="text-red-500">*</span></label>
                <input id="price" type="number" class="w-full px-3 py-2 bg-white border border-slate-300 rounded focus:border-primary-500 outline-none text-sm text-slate-800 font-mono" placeholder="0">
            </div>
        </div>

        <div class="border border-slate-200 p-4 rounded bg-slate-50">
            <label class="block text-sm font-semibold text-slate-700 mb-2 flex items-center gap-2">
                <i class="fa-solid fa-map-pin text-primary-600"></i> ตำแหน่งที่ตั้ง
            </label>
            <div class="flex gap-2 mb-2">
                <input id="mapSearchInput" type="text" placeholder="ค้นหาตำบล, อำเภอ..." class="flex-grow px-3 py-1.5 border border-slate-300 rounded text-sm outline-none focus:border-primary-500 bg-white" onkeypress="if(event.key==='Enter'){event.preventDefault();searchLocation();}">
                <button type="button" onclick="searchLocation()" class="px-4 py-1.5 bg-primary-700 text-white rounded text-sm hover:bg-primary-800 shadow-sm">ค้นหา</button>
            </div>
            <div id="map" class="border border-slate-300 shadow-sm h-48"></div>
            <div class="mt-2 text-right">
                 <span id="latlng_display" class="text-xs font-mono text-slate-400">0.00000, 0.00000</span>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-semibold text-slate-700 mb-1">ผู้ติดต่อ</label>
                <input id="contact_name" type="text" class="w-full px-3 py-2 bg-white border border-slate-300 rounded focus:border-primary-500 outline-none text-sm" placeholder="ชื่อ-สกุล">
            </div>
            <div>
                <label class="block text-sm font-semibold text-slate-700 mb-1">เขต/อำเภอ</label>
                <input id="address" type="text" class="w-full px-3 py-2 bg-white border border-slate-300 rounded focus:border-primary-500 outline-none text-sm" placeholder="ระบุอำเภอ">
            </div>
        </div>

        <div>
            <label class="block text-sm font-semibold text-slate-700 mb-1">รายละเอียดเพิ่มเติม</label>
            <textarea id="body" rows="4" class="w-full px-3 py-2 bg-white border border-slate-300 rounded focus:border-primary-500 outline-none text-sm" placeholder="รายละเอียดทรัพย์สิน..."></textarea>
        </div>
        
        <div>
            <div class="flex justify-between items-center mb-2">
                <label class="block text-sm font-semibold text-slate-700">รูปภาพประกอบ</label>
                <span id="imgCount" class="text-xs bg-slate-200 text-slate-600 px-2 py-0.5 rounded font-bold">0/3</span>
            </div>
            <div class="flex gap-3">
                <div id="previewList" class="flex gap-3"></div>
                <label id="uploadBtn" class="w-24 h-24 flex flex-col items-center justify-center border-2 border-dashed border-slate-300 rounded cursor-pointer hover:bg-slate-50 hover:border-primary-400 transition-all text-slate-400">
                    <i class="fa-solid fa-plus text-xl mb-1"></i>
                    <span class="text-xs">Upload</span>
                    <input id="img" type="file" class="hidden" accept="image/*" multiple onchange="appendImages(this)">
                </label>
            </div>
        </div>
    </div>
    
    <div class="px-6 py-4 bg-slate-50 border-t border-slate-200 flex justify-end gap-3 rounded-b-lg">
        <button onclick="closeModal()" class="px-5 py-2 border border-slate-300 rounded text-sm font-medium text-slate-600 hover:bg-white transition-colors">ยกเลิก</button>
        <button onclick="savePost()" id="btnSave" class="px-6 py-2 bg-primary-700 text-white rounded text-sm font-medium hover:bg-primary-800 shadow-sm transition-colors flex items-center gap-2">
            <span id="btnSaveText">บันทึกข้อมูล</span>
        </button>
    </div>
</dialog>

<script>
// --- CONFIGURATION ---
const API_URL = "https://script.google.com/macros/s/AKfycbxFPLZc1F9OAG0W9KJtv7MRVb8sqOU8YX5dUrIyyKYPJHXytEpHbWGtY7qlIJ02xyP6Rg/exec";
const PROVINCES = ["กรุงเทพมหานคร", "กระบี่", "กาญจนบุรี", "กาฬสินธุ์", "กำแพงเพชร", "ขอนแก่น", "จันทบุรี", "ฉะเชิงเทรา", "ชลบุรี", "ชัยนาท", "ชัยภูมิ", "ชุมพร", "เชียงราย", "เชียงใหม่", "ตรัง", "ตราด", "ตาก", "นครนายก", "นครปฐม", "นครพนม", "นครราชสีมา", "นครศรีธรรมราช", "นครสวรรค์", "นนทบุรี", "นราธิวาส", "น่าน", "บึงกาฬ", "บุรีรัมย์", "ปทุมธานี", "ประจวบคีรีขันธ์", "ปราจีนบุรี", "ปัตตานี", "พระนครศรีอยุธยา", "พะเยา", "พังงา", "พัทลุง", "พิจิตร", "พิษณุโลก", "เพชรบุรี", "เพชรบูรณ์", "แพร่", "ภูเก็ต", "มหาสารคาม", "มุกดาหาร", "แม่ฮ่องสอน", "ยโสธร", "ยะลา", "ร้อยเอ็ด", "ระนอง", "ระยอง", "ราชบุรี", "ลพบุรี", "ลำปาง", "ลำพูน", "เลย", "ศรีสะเกษ", "สกลนคร", "สงขลา", "สตูล", "สมุทรปราการ", "สมุทรสงคราม", "สมุทรสาคร", "สระแก้ว", "สระบุรี", "สิงห์บุรี", "สุโขทัย", "สุพรรณบุรี", "สุราษฎร์ธานี", "สุรินทร์", "หนองคาย", "หนองบัวลำภู", "อ่างทอง", "อำนาจเจริญ", "อุดรธานี", "อุตรดิตถ์", "อุทัยธานี", "อุบลราชธานี"].sort();

const defaultPosts = [
    {
        id: 101,
        title: "ที่ดินเปล่า 5 ไร่ ทำเลศักยภาพ (Demo)",
        price: 8500000,
        province: "เชียงใหม่",
        address: "อ.เมือง",
        contact_name: "บริษัท แลนด์ จำกัด",
        body: "ที่ดินสวย เหมาะสำหรับสร้างโครงการที่อยู่อาศัย หรือเก็งกำไรในอนาคต",
        images: ["https://images.unsplash.com/photo-1500382017468-9049fed747ef?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80"],
        lat: 18.7883,
        lng: 98.9853
    }
];

// --- STATE ---
let posts = [];
let filteredPosts = [];
let currentPage = 1;
const ITEMS_PER_PAGE = 9; // Grid 3xN

let formImages = [];
let sliderImages = [];
let sliderIndex = 0;
let map, marker;
let viewMap, viewMarker;
let reopenViewOnSliderClose = false;

const dom = {
    loading: document.getElementById('loading'), board: document.getElementById('board'),
    pagination: document.getElementById('pagination'), resultCount: document.getElementById('resultCount'),
    pageIndicator: document.getElementById('pageIndicator'),
    btnPrev: document.getElementById('btnPrev'), btnNext: document.getElementById('btnNext'),
    dlg: document.getElementById('dlg'), viewDlg: document.getElementById('viewDlg'),
    postId: document.getElementById('postId'),
    title: document.getElementById('title'), price: document.getElementById('price'),
    contactName: document.getElementById('contact_name'), address: document.getElementById('address'),
    province: document.getElementById('input_province'),
    body: document.getElementById('body'), imgInput: document.getElementById('img'),
    previewList: document.getElementById('previewList'), uploadBtn: document.getElementById('uploadBtn'),
    imgCount: document.getElementById('imgCount'),
    lat: document.getElementById('lat'), lng: document.getElementById('lng'),
    latlng_display: document.getElementById('latlng_display'),
    searchMain: document.getElementById('q_main'),
    slider: document.getElementById('imageSlider'), sliderImg: document.getElementById('sliderMainImage'),
    sliderCounter: document.getElementById('sliderCounter'),
    viewTitle: document.getElementById('viewTitle'), viewPriceHeader: document.getElementById('viewPriceHeader'),
    viewContact: document.getElementById('viewContact'), viewLocation: document.getElementById('viewLocation'),
    viewBody: document.getElementById('viewBody'), viewMapContainer: document.getElementById('viewMapContainer'),
    viewImages: document.getElementById('viewImages'), viewDeleteBtn: document.getElementById('btnDeletePost'),
    viewMainImage: document.getElementById('viewMainImage')
};

// --- INIT ---
function init() {
    populateProvinces();
    loadPosts(); 
    initMap();
    
    // Search listener (Debounced)
    dom.searchMain.addEventListener('input', debounce(applyFilters, 400));
}

function refreshApp() {
    dom.searchMain.value = '';
    loadPosts();
}

function populateProvinces() {
    const options = PROVINCES.map(p => `<option value="${p}">${p}</option>`).join('');
    dom.province.innerHTML = `<option value="">เลือกจังหวัด</option>${options}`;
}

async function loadPosts() {
    dom.loading.classList.remove('hidden');
    dom.board.classList.add('hidden');
    dom.pagination.classList.add('hidden');
    dom.resultCount.textContent = 'กำลังโหลด...';

    try {
        const response = await fetch(API_URL, { redirect: "follow" });
        if (!response.ok) throw new Error('Network error');
        
        const data = await response.json();
        let rawData = [];
        if (Array.isArray(data)) rawData = data;
        else if (data.data && Array.isArray(data.data)) rawData = data.data;
        
        posts = rawData.map(item => ({
            id: item.id || Date.now() + Math.random(),
            title: item.title || 'Untitled',
            price: Number(item.price) || 0,
            province: item.province || 'ไม่ระบุ',
            address: item.address || '',
            contact_name: item.contact_name || '',
            body: item.body || '',
            images: parseImages(item.images),
            lat: item.lat ? parseFloat(item.lat) : null,
            lng: item.lng ? parseFloat(item.lng) : null
        }));
        
    } catch (error) {
        console.error('API Error:', error);
        posts = [...defaultPosts];
        Swal.fire({
             toast: true, position: 'top-end', icon: 'info', 
             title: 'Demo Mode', text: 'Using sample data.',
             showConfirmButton: false, timer: 3000
        });
    } finally {
        applyFilters();
        dom.loading.classList.add('hidden');
        dom.board.classList.remove('hidden');
        dom.pagination.classList.remove('hidden');
    }
}

function parseImages(imgData) {
    if (!imgData) return [];
    if (Array.isArray(imgData)) return imgData;
    if (typeof imgData === 'string') {
        try {
            const parsed = JSON.parse(imgData);
            if (Array.isArray(parsed)) return parsed;
            return [imgData];
        } catch (e) {
            if (imgData.includes(',')) return imgData.split(',').map(s => s.trim());
            return [imgData];
        }
    }
    return [];
}

function applyFilters() {
    const q = dom.searchMain.value.toLowerCase().trim();
    
    filteredPosts = posts.filter(p => {
        // Search in title, province, body, and price string
        const combinedText = (p.title + ' ' + p.province + ' ' + p.address + ' ' + p.body + ' ' + p.price).toLowerCase();
        return combinedText.includes(q);
    });
    
    dom.resultCount.textContent = `ทั้งหมด ${filteredPosts.length} รายการ`;
    currentPage = 1;
    renderBoard();
}

function renderBoard() {
    dom.board.innerHTML = '';
    const start = (currentPage - 1) * ITEMS_PER_PAGE;
    const end = start + ITEMS_PER_PAGE;
    const pageData = filteredPosts.slice(start, end);
    
    if (pageData.length === 0) {
        dom.board.innerHTML = `
            <div class="col-span-full text-center py-20 bg-white rounded-lg border border-slate-200 shadow-sm">
                <i class="fa-solid fa-folder-open text-4xl text-slate-300 mb-4"></i>
                <h3 class="text-slate-600 font-bold">ไม่พบข้อมูล</h3>
                <p class="text-slate-400 text-sm">ลองค้นหาด้วยคำสำคัญอื่น</p>
            </div>`;
        return;
    }

    pageData.forEach(p => {
        const imgUrl = (p.images && p.images.length > 0) ? p.images[0] : 'https://placehold.co/600x400?text=No+Image';
        
        const card = document.createElement('div');
        // Layout: Serious Card Style (Border, Sharp Corners, Subtle Shadow)
        card.className = "bg-white rounded-lg border border-slate-200 overflow-hidden cursor-pointer hover:shadow-lg transition-shadow duration-300 flex flex-col h-full group";
        card.onclick = () => viewPost(p.id);
        
        // Responsive Card: Smaller text/padding on mobile (default), larger on md+
        card.innerHTML = `
            <div class="h-24 md:h-56 relative bg-slate-100 overflow-hidden">
                <img src="${imgUrl}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105">
                <div class="absolute top-0 right-0 bg-primary-700 text-white text-[9px] md:text-xs font-bold px-1.5 py-0.5 md:px-3 md:py-1 rounded-bl-lg shadow-sm">
                    ${p.province}
                </div>
                <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent p-1.5 md:p-4">
                    <p class="text-white font-bold text-xs md:text-lg leading-none truncate">฿${parseInt(p.price).toLocaleString()}</p>
                </div>
            </div>
            <div class="p-2 md:p-5 flex flex-col flex-grow">
                <h3 class="font-bold text-slate-800 text-[10px] md:text-lg leading-tight mb-1 md:mb-2 line-clamp-2 group-hover:text-primary-700 transition-colors h-7 md:h-auto">${p.title}</h3>
                <div class="flex items-center gap-1 md:gap-2 text-[9px] md:text-sm text-slate-500 mb-2 md:mb-4">
                     <i class="fa-solid fa-map-pin text-slate-400 text-[9px] md:text-sm"></i> <span class="truncate">${p.address || p.province}</span>
                </div>
                <div class="mt-auto border-t border-slate-100 pt-2 md:pt-4 flex justify-between items-center text-[9px] md:text-sm">
                    <span class="text-slate-400 font-medium hidden md:inline">ดูรายละเอียด</span>
                    <span class="text-slate-400 font-medium md:hidden">ดู</span>
                    <i class="fa-solid fa-arrow-right text-primary-600 md:opacity-0 group-hover:opacity-100 transition-opacity transform -translate-x-2 group-hover:translate-x-0"></i>
                </div>
            </div>
        `;
        dom.board.appendChild(card);
    });
    
    updatePagination();
}

function updatePagination() {
    const totalPages = Math.ceil(filteredPosts.length / ITEMS_PER_PAGE) || 1;
    dom.pageIndicator.textContent = `${currentPage} / ${totalPages}`;
    dom.btnPrev.disabled = currentPage === 1;
    dom.btnNext.disabled = currentPage === totalPages;
}

function changePage(delta) {
    currentPage += delta;
    renderBoard();
    dom.board.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function debounce(func, wait) {
    let timeout;
    return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
    };
}

// --- MAP ---
function initMap() {
    map = L.map('map', {zoomControl: false}).setView([13.7563, 100.5018], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '' }).addTo(map);
    L.control.zoom({position: 'bottomright'}).addTo(map);
    map.on('click', e => updateMarker(e.latlng.lat, e.latlng.lng));
}

function updateMarker(lat, lng) {
    if (marker) marker.setLatLng([lat, lng]);
    else {
        marker = L.marker([lat, lng], {draggable: true}).addTo(map);
        marker.on('dragend', e => updateFormCoords(marker.getLatLng().lat, marker.getLatLng().lng));
    }
    updateFormCoords(lat, lng);
    map.panTo([lat, lng]);
}

function updateFormCoords(lat, lng) {
    dom.lat.value = lat; dom.lng.value = lng;
    dom.latlng_display.textContent = `${lat.toFixed(5)}, ${lng.toFixed(5)}`;
}

async function searchLocation() {
    const query = document.getElementById('mapSearchInput').value;
    if (!query) return;
    
    try {
        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`);
        const data = await res.json();
        if (data && data.length > 0) {
            const lat = parseFloat(data[0].lat);
            const lon = parseFloat(data[0].lon);
            updateMarker(lat, lon);
            map.setView([lat, lon], 12);
        } else {
            Swal.fire({icon: 'warning', title: 'ไม่พบตำแหน่ง', toast: true, position: 'top', showConfirmButton: false, timer: 2000});
        }
    } catch (e) { console.error(e); }
}

// --- MODAL ---
function openNewPostModal() {
    resetForm();
    dom.dlg.showModal();
    setTimeout(() => map.invalidateSize(), 300);
}

function closeModal() {
    dom.dlg.close();
    resetForm();
}

function resetForm() {
    dom.postId.value = '';
    dom.title.value = '';
    dom.price.value = '';
    dom.contactName.value = '';
    dom.address.value = '';
    dom.body.value = '';
    dom.province.value = '';
    dom.imgInput.value = '';
    dom.lat.value = '';
    dom.lng.value = '';
    dom.latlng_display.textContent = '0.00000, 0.00000';
    formImages = [];
    dom.previewList.innerHTML = '';
    dom.imgCount.textContent = '0/3';
    
    if (marker) {
        map.removeLayer(marker);
        marker = null;
    }
    map.setView([13.7563, 100.5018], 5);
    document.querySelectorAll('.input-error').forEach(el => el.classList.remove('input-error'));
}

// --- VIEW ---
function viewPost(id) {
    const post = posts.find(p => p.id === id);
    if (!post) return;
    
    dom.viewTitle.textContent = post.title;
    dom.viewPriceHeader.textContent = '฿' + parseInt(post.price).toLocaleString();
    dom.viewContact.textContent = post.contact_name || '-';
    dom.viewLocation.textContent = (post.address ? post.address + ' ' : '') + post.province;
    dom.viewBody.textContent = post.body || '-';
    
    // Gallery
    dom.viewImages.innerHTML = '';
    sliderImages = post.images && post.images.length ? post.images : [];
    
    if (sliderImages.length > 0) {
        dom.viewMainImage.src = sliderImages[0];
        sliderImages.forEach((url, idx) => {
            const img = document.createElement('img');
            img.src = url;
            img.className = "h-full w-auto aspect-square object-cover rounded cursor-pointer border-2 border-transparent hover:border-primary-500 transition-all";
            img.onclick = () => { dom.viewMainImage.src = url; };
            dom.viewImages.appendChild(img);
        });
    } else {
        dom.viewMainImage.src = 'https://placehold.co/600x400?text=No+Image';
    }
    
    // Map View
    if (post.lat && post.lng) {
        dom.viewMapContainer.classList.remove('hidden');
        if (!viewMap) {
            viewMap = L.map('viewMap', {zoomControl: false});
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '' }).addTo(viewMap);
        }
        setTimeout(() => {
            viewMap.invalidateSize();
            viewMap.setView([post.lat, post.lng], 12);
            if (viewMarker) viewMap.removeLayer(viewMarker);
            viewMarker = L.marker([post.lat, post.lng]).addTo(viewMap);
        }, 200);
        document.getElementById('viewMapLink').href = `https://www.google.com/maps/search/?api=1&query=${post.lat},${post.lng}`;
    } else {
        dom.viewMapContainer.classList.add('hidden');
    }
    
    dom.viewDeleteBtn.onclick = () => deletePost(post.id);
    dom.viewDlg.showModal();
}

function closeViewModal() {
    dom.viewDlg.close();
    reopenViewOnSliderClose = false;
}

// --- SLIDER ---
function openImageSlider(index) {
    if (sliderImages.length === 0) return;
    sliderIndex = index;
    updateSliderImage();
    if (dom.viewDlg.open) { dom.viewDlg.close(); reopenViewOnSliderClose = true; }
    dom.slider.classList.remove('hidden');
    setTimeout(() => { dom.slider.classList.remove('slider-hidden'); dom.slider.classList.add('slider-visible'); }, 10);
}
function closeImageSlider() {
    dom.slider.classList.remove('slider-visible'); dom.slider.classList.add('slider-hidden');
    setTimeout(() => { dom.slider.classList.add('hidden'); if(reopenViewOnSliderClose){ dom.viewDlg.showModal(); reopenViewOnSliderClose=false; } }, 300);
}
function changeSlide(step) {
    if (sliderImages.length === 0) return;
    sliderIndex = (sliderIndex + step + sliderImages.length) % sliderImages.length;
    updateSliderImage();
}
function updateSliderImage() {
    dom.sliderImg.src = sliderImages[sliderIndex];
    dom.sliderCounter.textContent = `${sliderIndex + 1} / ${sliderImages.length}`;
}

// --- IMAGES ---
function appendImages(input) {
    if (input.files) {
        const remaining = 3 - formImages.length;
        const filesToProcess = Array.from(input.files).slice(0, remaining);
        filesToProcess.forEach(file => {
            const reader = new FileReader();
            reader.onload = (e) => { formImages.push(e.target.result); renderFormImages(); };
            reader.readAsDataURL(file);
        });
    }
}
function renderFormImages() {
    dom.previewList.innerHTML = '';
    formImages.forEach((src, idx) => {
        const div = document.createElement('div');
        div.className = "relative w-24 h-24 rounded overflow-hidden border border-slate-200 group";
        div.innerHTML = `<img src="${src}" class="w-full h-full object-cover"><button onclick="removeImage(${idx})" class="absolute top-1 right-1 bg-red-600 text-white w-5 h-5 rounded-full text-xs flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity"><i class="fa-solid fa-times"></i></button>`;
        dom.previewList.appendChild(div);
    });
    dom.imgCount.textContent = `${formImages.length}/3`;
    if(formImages.length >= 3) dom.uploadBtn.classList.add('hidden'); else dom.uploadBtn.classList.remove('hidden');
}
function removeImage(idx) { formImages.splice(idx, 1); renderFormImages(); }

// --- ACTIONS ---
function validateForm() {
    let isValid = true;
    if (!dom.title.value.trim()) { dom.title.classList.add('input-error'); isValid = false; }
    if (!dom.price.value) { dom.price.classList.add('input-error'); isValid = false; }
    if (!dom.province.value) { dom.province.classList.add('input-error'); isValid = false; }
    return isValid;
}

async function savePost() {
    if (!validateForm()) { setTimeout(() => document.querySelectorAll('.input-error').forEach(el => el.classList.remove('input-error')), 500); return; }
    
    const btn = document.getElementById('btnSave');
    const txt = document.getElementById('btnSaveText');
    const originalText = txt.textContent;
    txt.textContent = 'Saving...'; btn.disabled = true;

    const formData = new FormData();
    formData.append('action', 'create');
    formData.append('title', dom.title.value);
    formData.append('price', dom.price.value);
    formData.append('province', dom.province.value);
    formData.append('address', dom.address.value);
    formData.append('contact_name', dom.contactName.value);
    formData.append('body', dom.body.value);
    formData.append('lat', dom.lat.value);
    formData.append('lng', dom.lng.value);
    formData.append('images', JSON.stringify(formImages));

    try {
        await fetch(API_URL, { method: 'POST', body: formData });
        
        const newPost = {
            id: Date.now(), 
            title: dom.title.value, price: Number(dom.price.value), province: dom.province.value,
            address: dom.address.value, contact_name: dom.contactName.value, body: dom.body.value,
            lat: dom.lat.value ? parseFloat(dom.lat.value) : null, lng: dom.lng.value ? parseFloat(dom.lng.value) : null,
            images: formImages
        };
        posts.unshift(newPost);
        applyFilters();
        Swal.fire({icon: 'success', title: 'Saved', timer: 1500, showConfirmButton: false});
        closeModal();
    } catch (e) {
        console.error(e);
        Swal.fire('Error', 'Connection failed', 'error');
    } finally {
        txt.textContent = originalText; btn.disabled = false;
    }
}

function deletePost(id) {
    closeViewModal();
    Swal.fire({
        title: 'ยืนยันการลบ', text: "รายการนี้จะถูกลบถาวร", icon: 'warning',
        showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'ลบ', cancelButtonText: 'ยกเลิก',
        preConfirm: async () => {
             const fd = new FormData(); fd.append('action', 'delete'); fd.append('id', id);
             try { await fetch(API_URL, { method: 'POST', body: fd }); return true; } catch(e){ return false; }
        }
    }).then((result) => {
        if (result.isConfirmed) {
            posts = posts.filter(p => p.id !== id);
            applyFilters();
            Swal.fire({title: 'ลบแล้ว', icon: 'success', timer: 1000, showConfirmButton: false});
        }
    });
}

function fillDemoData() {
    dom.title.value = "ที่ดิน 10 ไร่ ทำเลทอง ติดถนนสายหลัก";
    dom.price.value = "15000000";
    dom.province.value = "นนทบุรี";
    dom.address.value = "อ.ปากเกร็ด";
    dom.contactName.value = "คุณศักดิ์ชัย";
    dom.body.value = "ขายที่ดินแปลงสวย ถมแล้ว พร้อมโอน\n- หน้ากว้าง 80 เมตร\n- ไฟฟ้า 3 เฟส\n- เหมาะทำโกดัง หรือจัดสรร";
    const lat = 13.900 + (Math.random() * 0.05); const lng = 100.500 + (Math.random() * 0.05);
    updateMarker(lat, lng);
    formImages = ["https://images.unsplash.com/photo-1500382017468-9049fed747ef?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80"];
    renderFormImages();
}

// Start
init();
</script>
</body>
</html>
