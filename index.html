<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>‡∏ï‡∏•‡∏≤‡∏î‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô | Land Market</title>

<!-- Google Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Font Awesome Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<!-- SweetAlert2 (Popups) -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
    body { font-family: 'Prompt', sans-serif; background-color: #f3f4f6; }
    
    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

    /* Dialog Animation */
    dialog { transition: all 0.3s allow-discrete; opacity: 0; transform: scale(0.95); }
    dialog[open] { opacity: 1; transform: scale(1); }
    dialog::backdrop { background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); }
    
    .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    .line-clamp-3 {
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
</style>
</head>

<body class="text-gray-800 min-h-screen flex flex-col">

<!-- Header / Navbar -->
<nav class="bg-white shadow-sm sticky top-0 z-50">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex justify-between h-16 items-center">
      <!-- Logo -->
      <div class="flex items-center gap-2 cursor-pointer" onclick="window.location.reload()">
        <div class="bg-blue-600 text-white p-2 rounded-lg">
          <i class="fa-solid fa-map-location-dot text-xl"></i>
        </div>
        <span class="font-bold text-xl text-blue-900 tracking-tight">Land<span class="text-blue-600">Market</span></span>
      </div>

      <!-- Right Side Actions -->
      <div class="flex items-center gap-3">
        <!-- Search (Desktop) -->
        <div class="hidden md:flex relative mr-2">
            <input id="q_desktop" type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏≥‡πÄ‡∏•, ‡∏£‡∏≤‡∏Ñ‡∏≤..." 
                   class="pl-10 pr-4 py-2 border border-gray-200 rounded-full text-sm focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 w-64 transition-all">
            <i class="fa-solid fa-search absolute left-3.5 top-3 text-gray-400"></i>
        </div>

        <!-- User Profile / Login -->
        <div id="userSection" class="flex items-center gap-3">
            <div id="loadingUser" class="text-xs text-gray-400">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
            <button id="btnLogin" class="hidden flex items-center gap-2 bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-full text-sm font-medium hover:bg-gray-50 transition-colors shadow-sm">
                <i class="fa-brands fa-google text-red-500"></i>
                ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
            </button>
        </div>
      </div>
    </div>
  </div>
</nav>

<!-- Mobile Search Bar -->
<div class="md:hidden bg-white border-b border-gray-200 p-3 sticky top-16 z-40">
    <div class="relative">
        <input id="q_mobile" type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏≥‡πÄ‡∏•, ‡∏£‡∏≤‡∏Ñ‡∏≤..." class="w-full pl-10 pr-4 py-2 bg-gray-100 border-none rounded-lg text-sm focus:ring-2 focus:ring-blue-500">
        <i class="fa-solid fa-search absolute left-3.5 top-2.5 text-gray-500"></i>
    </div>
</div>

<!-- Main Content -->
<main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full">
    
    <!-- Hero Section / Title -->
    <div class="flex justify-between items-end mb-6">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏Ç‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h1>
            <p class="text-gray-500 text-sm mt-1">‡∏Ñ‡πâ‡∏ô‡∏û‡∏ö‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡πÅ‡∏•‡∏∞‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô‡∏™‡∏ß‡∏¢‡πÜ ‡∏ó‡∏±‡πà‡∏ß‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®</p>
        </div>
        <button id="btnNew" onclick="openNewPostModal()" class="hidden bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-lg shadow-md transition-all flex items-center gap-2 transform active:scale-95">
            <i class="fa-solid fa-plus"></i> ‡∏•‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ü‡∏£‡∏µ
        </button>
    </div>

    <!-- Loading State -->
    <div id="loading" class="flex flex-col items-center justify-center py-20 text-gray-400">
        <i class="fa-solid fa-circle-notch fa-spin text-4xl text-blue-500 mb-4"></i>
        <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
    </div>

    <!-- Listings Grid -->
    <section id="board" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 hidden"></section>

</main>

<!-- Footer -->
<footer class="bg-white border-t border-gray-200 mt-10 py-6">
    <div class="text-center text-gray-500 text-sm">
        &copy; 2024 LandMarket Platform. All rights reserved.
    </div>
</footer>

<!-- Modal / Dialog for New Post -->
<dialog id="dlg" class="bg-white rounded-2xl shadow-2xl p-0 w-full max-w-lg backdrop:bg-gray-900/50">
    <div class="p-6 border-b border-gray-100 flex justify-between items-center">
        <h3 class="text-lg font-bold text-gray-900">‡∏•‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏Ç‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô</h3>
        <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 w-8 h-8 rounded-full hover:bg-gray-100 flex items-center justify-center transition-colors">
            <i class="fa-solid fa-xmark text-lg"></i>
        </button>
    </div>
    
    <div class="p-6 space-y-4">
        <!-- Title -->
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</label>
            <input id="title" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ç‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô‡∏ï‡∏¥‡∏î‡πÅ‡∏°‡πà‡∏ô‡πâ‡∏≥ 2 ‡πÑ‡∏£‡πà" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all">
        </div>

        <!-- Name & Address (New) -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</label>
                <input id="contact_name" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• ‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition-all">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà / ‡∏ó‡∏≥‡πÄ‡∏•‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á</label>
                <input id="address" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏≠.‡πÄ‡∏°‡∏∑‡∏≠‡∏á ‡∏à.‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition-all">
            </div>
        </div>

        <!-- Price -->
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó)</label>
            <div class="relative">
                <input id="price" type="number" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏Ñ‡∏≤" class="w-full px-4 py-2 pl-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition-all">
                <span class="absolute left-4 top-2 text-gray-400">‡∏ø</span>
            </div>
        </div>

        <!-- Details -->
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</label>
            <textarea id="body" rows="4" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà, ‡πÇ‡∏â‡∏ô‡∏î, ‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition-all resize-none"></textarea>
        </div>

        <!-- Image -->
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô</label>
            <label class="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100 transition-colors relative overflow-hidden group">
                <div class="flex flex-col items-center justify-center pt-5 pb-6 text-gray-500 group-hover:text-blue-500" id="uploadPlaceholder">
                    <i class="fa-solid fa-cloud-arrow-up text-2xl mb-2"></i>
                    <p class="text-xs">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</p>
                </div>
                <img id="imgPreview" class="absolute inset-0 w-full h-full object-cover hidden">
                <input id="img" type="file" class="hidden" accept="image/*" onchange="previewImage(this)">
            </label>
            <button id="btnRemoveImg" onclick="removeImage()" class="hidden text-xs text-red-500 mt-1 hover:underline">‡∏•‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</button>
        </div>
    </div>

    <div class="p-6 border-t border-gray-100 bg-gray-50 flex justify-end gap-3 rounded-b-2xl">
        <button onclick="closeModal()" class="px-5 py-2.5 rounded-lg border border-gray-300 text-gray-700 text-sm font-medium hover:bg-white transition-colors">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button onclick="savePost()" id="btnSave" class="px-5 py-2.5 rounded-lg bg-blue-600 text-white text-sm font-medium hover:bg-blue-700 shadow-md flex items-center gap-2">
            <span id="btnSaveText">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</span>
            <i id="btnSaveIcon" class="fa-solid fa-paper-plane"></i>
        </button>
    </div>
</dialog>

<script>
// --- State Management ---
let posts = [];
let currentUser = null;

// --- Elements ---
const dom = {
    loading: document.getElementById('loading'),
    board: document.getElementById('board'),
    q_desktop: document.getElementById('q_desktop'),
    q_mobile: document.getElementById('q_mobile'),
    btnLogin: document.getElementById('btnLogin'),
    btnNew: document.getElementById('btnNew'),
    userSection: document.getElementById('userSection'),
    loadingUser: document.getElementById('loadingUser'),
    dlg: document.getElementById('dlg'),
    imgInput: document.getElementById('img'),
    imgPreview: document.getElementById('imgPreview'),
    uploadPlaceholder: document.getElementById('uploadPlaceholder'),
    btnRemoveImg: document.getElementById('btnRemoveImg')
};

// --- Initialization ---
function init() {
    // 1. Check Login
    google.script.run
        .withSuccessHandler(renderUserHeader)
        .withFailureHandler(err => console.error(err))
        .clientGetProfile();

    // 2. Load Posts
    loadPosts();

    // 3. Bind Events
    dom.q_desktop.addEventListener('input', (e) => filterPosts(e.target.value));
    dom.q_mobile.addEventListener('input', (e) => filterPosts(e.target.value));
}

// --- User & Auth ---
function renderUserHeader(userData) {
    dom.loadingUser.remove();
    
    if (userData && userData.email) {
        currentUser = userData.email;
        dom.btnLogin.classList.add('hidden');
        dom.btnNew.classList.remove('hidden');
        
        const avatarUrl = userData.photo || "https://ui-avatars.com/api/?background=0D8ABC&color=fff&name=" + (userData.name || 'User');
        
        const profileHtml = `
            <div class="flex items-center gap-3">
                <div class="text-right hidden sm:block">
                    <div class="text-sm font-semibold text-gray-900">${userData.name || currentUser}</div>
                    <div class="text-xs text-gray-500">Member</div>
                </div>
                <img src="${avatarUrl}" class="w-10 h-10 rounded-full border-2 border-white shadow-sm object-cover">
            </div>
        `;
        
        const div = document.createElement('div');
        div.innerHTML = profileHtml;
        dom.userSection.appendChild(div);
    } else {
        // Not logged in (Guest)
        dom.btnLogin.classList.remove('hidden');
        dom.btnNew.classList.add('hidden');
    }
}

// --- Data Loading ---
function loadPosts() {
    dom.loading.classList.remove('hidden');
    dom.board.classList.add('hidden');
    
    google.script.run
        .withSuccessHandler(data => {
            posts = data || [];
            renderPosts(posts);
            dom.loading.classList.add('hidden');
            dom.board.classList.remove('hidden');
        })
        .withFailureHandler(err => {
            console.error(err);
            dom.loading.innerHTML = `<p class="text-red-500">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß</p>`;
        })
        .clientGetPosts();
}

function renderPosts(data) {
    if (!data || data.length === 0) {
        dom.board.innerHTML = `
            <div class="col-span-full flex flex-col items-center justify-center py-16 text-gray-400">
                <i class="fa-regular fa-folder-open text-5xl mb-4"></i>
                <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</p>
            </div>
        `;
        return;
    }

    dom.board.innerHTML = data.map(p => {
        const isOwner = currentUser && p.author === currentUser;
        const imgUrl = p.images?.[0] || 'https://placehold.co/600x400/e2e8f0/94a3b8?text=No+Image';
        const priceFmt = parseInt(p.price || 0).toLocaleString('th-TH');
        const dateFmt = new Date(p.createdAt).toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: 'numeric' });

        return `
        <article class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden hover:shadow-md transition-shadow group flex flex-col h-full">
            <div class="relative aspect-[4/3] overflow-hidden bg-gray-100">
                <img src="${imgUrl}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500">
                <div class="absolute top-2 right-2 bg-white/90 backdrop-blur-sm px-2 py-1 rounded-md text-xs font-semibold text-gray-700 shadow-sm">
                    <i class="fa-solid fa-tag text-blue-500 mr-1"></i> ‡∏Ç‡∏≤‡∏¢
                </div>
                ${isOwner ? `
                <button onclick="delPost('${p.id}')" class="absolute top-2 left-2 bg-red-500 text-white w-8 h-8 rounded-full flex items-center justify-center shadow-sm opacity-0 group-hover:opacity-100 transition-opacity">
                    <i class="fa-solid fa-trash text-xs"></i>
                </button>
                ` : ''}
            </div>
            
            <div class="p-4 flex flex-col flex-grow">
                <div class="flex justify-between items-start mb-2">
                    <h3 class="font-semibold text-gray-900 line-clamp-2 text-lg leading-tight h-[3.5rem]">${p.title || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠'}</h3>
                </div>
                
                <div class="text-blue-600 font-bold text-xl mb-3">‡∏ø${priceFmt}</div>
                
                <p class="text-gray-500 text-sm line-clamp-3 mb-4 flex-grow whitespace-pre-line">${p.body || '-'}</p>
                
                <div class="border-t border-gray-100 pt-3 flex items-center justify-between mt-auto">
                    <span class="text-xs text-gray-400">
                        <i class="fa-regular fa-clock mr-1"></i> ${dateFmt}
                    </span>
                    <span class="text-xs text-gray-500">
                         <i class="fa-regular fa-user mr-1"></i> ${p.author.split('@')[0]}
                    </span>
                </div>
            </div>
        </article>
        `;
    }).join("");
}

function filterPosts(keyword) {
    const kw = keyword.toLowerCase();
    const filtered = posts.filter(p => 
        (p.title || "").toLowerCase().includes(kw) || 
        (p.body || "").toLowerCase().includes(kw)
    );
    renderPosts(filtered);
}

// --- CRUD Actions ---

function openNewPostModal() {
    resetForm();
    dom.dlg.showModal();
}

function closeModal() {
    dom.dlg.close();
}

function previewImage(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            dom.imgPreview.src = e.target.result;
            dom.imgPreview.classList.remove('hidden');
            dom.uploadPlaceholder.classList.add('opacity-0');
            dom.btnRemoveImg.classList.remove('hidden');
        }
        reader.readAsDataURL(input.files[0]);
    }
}

function removeImage() {
    dom.imgInput.value = "";
    dom.imgPreview.src = "";
    dom.imgPreview.classList.add('hidden');
    dom.uploadPlaceholder.classList.remove('opacity-0');
    dom.btnRemoveImg.classList.add('hidden');
}

function savePost() {
    const title = document.getElementById('title').value;
    const price = document.getElementById('price').value;
    const contactName = document.getElementById('contact_name').value;
    const address = document.getElementById('address').value;
    const bodyText = document.getElementById('body').value;
    const file = dom.imgInput.files[0];

    if(!title || !price) {
        Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏Ñ‡∏≤', 'warning');
        return;
    }

    setLoadingState(true);

    // Combine extra fields into body
    let fullBody = "";
    if (address) fullBody += `üìç ‡∏ó‡∏≥‡πÄ‡∏•: ${address}\n\n`;
    if (bodyText) fullBody += `${bodyText}\n\n`;
    if (contactName) fullBody += `üë§ ‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠: ${contactName}`;

    // 1. Helper to upload then save
    const processSave = (imgUrl) => {
        const postData = {
            title: title,
            price: price,
            body: fullBody.trim(),
            images: imgUrl ? [imgUrl] : []
        };
        
        google.script.run
            .withSuccessHandler(res => {
                setLoadingState(false);
                if(res.error) {
                    Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', res.error, 'error');
                } else {
                    closeModal();
                    Swal.fire({
                        icon: 'success', title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text: '‡∏•‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                        timer: 1500, showConfirmButton: false
                    });
                    loadPosts();
                }
            })
            .withFailureHandler(err => {
                setLoadingState(false);
                Swal.fire('Error', err.toString(), 'error');
            })
            .clientSavePost(postData);
    };

    // 2. Upload Logic
    if (file) {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => {
             // Send base64 to server
            google.script.run
                .withSuccessHandler(res => {
                    if(res.error) {
                        setLoadingState(false);
                        Swal.fire('Upload Failed', res.error, 'error');
                    } else {
                        processSave(res.url);
                    }
                })
                .clientUpload(reader.result, file.name);
        };
    } else {
        processSave(null);
    }
}

function delPost(id) {
    Swal.fire({
        title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?', text: "‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà", icon: 'warning',
        showCancelButton: true, confirmButtonColor: '#ef4444', confirmButtonText: '‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®', cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
    }).then((result) => {
        if (result.isConfirmed) {
            Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...', didOpen: () => Swal.showLoading() });
            
            google.script.run
                .withSuccessHandler(res => {
                    Swal.close();
                    if(res.error) {
                        Swal.fire('Error', res.error, 'error');
                    } else {
                        loadPosts();
                        const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 3000 });
                        Toast.fire({ icon: 'success', title: '‡∏•‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß' });
                    }
                })
                .clientDeletePost(id);
        }
    });
}

function setLoadingState(isLoading) {
    const btn = document.getElementById('btnSave');
    const txt = document.getElementById('btnSaveText');
    const icon = document.getElementById('btnSaveIcon');
    
    if (isLoading) {
        btn.disabled = true;
        btn.classList.add('opacity-75', 'cursor-not-allowed');
        txt.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
        icon.classList.remove('fa-paper-plane');
        icon.classList.add('fa-circle-notch', 'fa-spin');
    } else {
        btn.disabled = false;
        btn.classList.remove('opacity-75', 'cursor-not-allowed');
        txt.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®';
        icon.classList.add('fa-paper-plane');
        icon.classList.remove('fa-circle-notch', 'fa-spin');
    }
}

function resetForm() {
    document.getElementById('title').value = '';
    document.getElementById('price').value = '';
    document.getElementById('contact_name').value = '';
    document.getElementById('address').value = '';
    document.getElementById('body').value = '';
    removeImage();
}

// Start
init();
</script>

</body>
</html>
