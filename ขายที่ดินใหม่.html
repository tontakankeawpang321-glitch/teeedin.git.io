<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ขายที่ดิน – Google Drive Backend</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
/* ====== UI เดิม (ย่อจากของคุณ) ====== */
body{margin:0;font-family:system-ui;background:#f7f8fb}
header{background:#fff;border-bottom:1px solid #e5e7eb;padding:12px 16px;display:flex;gap:12px;align-items:center}
.btn{padding:8px 12px;border-radius:8px;border:0;background:#2563eb;color:#fff;cursor:pointer}
.btn.ghost{background:#eef2ff;color:#1e40af}
.wrap{max-width:1100px;margin:20px auto;padding:0 16px}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px}
.card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;overflow:hidden}
.thumb{width:100%;aspect-ratio:16/10;object-fit:cover;background:#eee}
.meta{padding:10px}
.muted{color:#6b7280;font-size:13px}
dialog{border:0;border-radius:14px;padding:16px}
</style>
</head>

<body>

<header>
  <div id="userBox" class="muted">ยังไม่ได้เข้าสู่ระบบ</div>
  <div style="flex:1"></div>
  <button class="btn ghost" onclick="checkLogin()">เช็กสถานะ</button>
  <button class="btn" onclick="openEditor()">+ ลงประกาศ</button>
</header>

<main class="wrap">
  <input id="q" placeholder="ค้นหา..." style="width:100%;padding:10px;margin-bottom:12px">
  <section id="board" class="grid"></section>
</main>

<!-- ===== Editor ===== -->
<dialog id="dlg">
  <h3>ลงประกาศขายที่ดิน</h3>
  <input id="title" placeholder="หัวเรื่อง" style="width:100%;padding:8px"><br><br>
  <input id="price" type="number" placeholder="ราคา"><br><br>
  <textarea id="body" placeholder="รายละเอียด" style="width:100%;height:80px"></textarea><br><br>
  <input type="file" id="img"><br><br>
  <button class="btn" onclick="savePost()">บันทึก</button>
  <button class="btn ghost" onclick="dlg.close()">ยกเลิก</button>
</dialog>

<script>
/* ================= CONFIG ================= */
const API_URL = "https://script.google.com/macros/s/AKfycbxn9WF_XSX2qc2rhtzXCDJaWNkjKuliuRzfRWPOoqMAzNnSP80Yk6DsOOSC8TXVw2QDgw/exec";

let posts = [];
let currentUser = null;

/* ================= LOAD ================= */
async function loadAll(){
  const r = await fetch(API_URL + "?action=list");
  const d = await r.json();
  currentUser = d.user;
  posts = d.posts || [];
  document.getElementById("userBox").textContent =
    currentUser ? "ผู้ใช้: " + currentUser : "ยังไม่ได้เข้าสู่ระบบ";
  render(posts);
}

function render(list){
  const kw = document.getElementById("q").value.toLowerCase();
  const f = list.filter(p =>
    !kw || (p.title||"").toLowerCase().includes(kw)
  );

  board.innerHTML = f.map(p => `
    <article class="card">
      <img class="thumb" src="${p.images?.[0]?.url || ''}">
      <div class="meta">
        <b>${p.title || '-'}</b>
        <div class="muted">ราคา: ${p.price || '-'}</div>
        <button class="btn ghost" onclick="view('${p.id}')">ดูรายละเอียด</button>
      </div>
    </article>
  `).join("") || "<div class='muted'>ยังไม่มีประกาศ</div>";
}

q.oninput = () => render(posts);

/* ================= LOGIN ================= */
async function checkLogin(){
  const r = await fetch(API_URL + "?action=whoami");
  const d = await r.json();
  alert(d.email ? "Login: "+d.email : "ยังไม่ได้ Login");
}

/* ================= EDITOR ================= */
const dlg = document.getElementById("dlg");

function openEditor(){
  dlg.showModal();
}

/* ================= SAVE ================= */
async function savePost(){
  let images = [];
  const f = img.files[0];
  if (f){
    images.push({ url: await uploadImage(f) });
  }

  await fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({
      action:"save",
      post:{
        title:title.value,
        price:price.value,
        body:body.value,
        images
      }
    })
  });

  dlg.close();
  loadAll();
}

/* ================= UPLOAD ================= */
function fileToBase64(file){
  return new Promise(res=>{
    const r = new FileReader();
    r.onload=()=>res(r.result);
    r.readAsDataURL(file);
  });
}

async function uploadImage(file){
  const b64 = await fileToBase64(file);
  const r = await fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({
      action:"upload",
      base64:b64.split(",")[1],
      name:file.name
    })
  });
  return (await r.json()).url;
}

/* ================= INIT ================= */
loadAll();
</script>

</body>
</html>
